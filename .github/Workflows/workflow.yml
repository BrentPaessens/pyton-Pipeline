name: python-api-devops

on:
  push: 
    branches: [ main ]
        
jobs: 
  test:
    runs-on: ubuntu-latest
      steps:
        - name: checkout code
          uses: actions/checkout@v3
        - name: set up python
          uses: actions/setup-python@v4
          with:
             python-version: '3.10'
           
        - name: install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install flake8
            
        - name: Run flake8
          run: flake8 main.py
         
    delivery:
      needs: test
      runs-on: ubuntu-latest
      steps:
        - name: checkout code
          uses: actions/checkout@v3
        - name: Build Docker image
          run: docker build -t ${{secrets.DOCKER_USERNAME}}/fastapi-app:latest .
         
        - name: log in to Docker hub
          uses: docker/login-action@v1
          with:
            username: ${{secrets.DOCKER_USERNAME}}
            password: ${{secrets.DOCKER_PASSWORD}}
         
        - name: Push Docker image 
          run: docker push ${{secrets.DOCKER_USERNAME}}/fastapi-app:latest